<!-- Import X-Tag -->

<script>
    'use strict';
    (function(xtag, datastore) {
        xtag.register('x-cyclicBuffer', {
            lifecycle: {
                created: function() {
                    this.innerHTML = this.identifier;
                    this.updateData();
                    console.log(dataStore.allDataContainer.temp_setting_1_week);
                }
            },
            events: {
                click: function(devId){
                    //console.log('click', devId.srcElement.id);
                    if(devId.srcElement.id.split("-").length !== 2 && 
                            (devId.srcElement.id.split("-")[1] !== 'temperatureSavePoints' || devId.srcElement.id.split("-")[1] !== 'temperatureSetPoints')){
                        return;
                    }
                    var action = devId.srcElement.id.split("-")[0];

                    if(action === 'smooth'){
                        this.smooth();
                    } else if(action === 'set'){
                        this.setTemperature();
                    } else if(action === 'cancel'){
                        this.cancel();
                    } else if(action === 'save'){
                        this.save();
                    } else if(devId.srcElement.id.split("-")[1] === 'temperatureSetPoints'){
                        this.clicked = true;
                        xtag.fireEvent(devId.srcElement, 'move');
                    }
                },
                onchange: function(devId){
                    console.log('onchange', devId.srcElement.id);
                    var action = devId.srcElement.id.split("-")[0];

                    if(action === 'set'){
                        this.setTemperature();
                    }
                },
                'move': function(devId){
                    console.log('move', devId.srcElement.id);
                    
                    if(!devId.srcElement.id || devId.srcElement.id.split("-").length !== 2 || devId.srcElement.id.split("-")[1] !== 'temperatureSetPoints'){
                        return;
                    }

                    var index = devId.srcElement.id.split("-")[0];
                    console.log('move', index);
                    if(mouseState === "down" || this.clicked){
                        delete this.clicked;
                        var day = Math.floor(index / (60*24));
                        var time = index % (60*24);
                        console.log('dragging', devId.srcElement.id, index, day, time);

                        if(!this.dragging){
                            // Just started dragging.
                            this.dragging = true;
                            this.dragStartDay = day;
                            this.dragStartTime = time;
                            this.clearSelected();
                        }
                        this.displayDrag(index);
                    } else {
                        if(this.dragging){
                            // Just finished dragging.
                            delete this.dragging;
                            this.displayDrag(index);
                        }
                    }
                },
            },
            accessors: {
                identifier: {
                    attribute: {},
                    get: function(){
                        return this.getAttribute('identifier') || "none"
                    },
                    set: function(value){
                        this.xtag.data.identifier = value;
                    }
                }
            },
            methods: {
                clearSelected: function(){
                    var selectedNode;
                    for(var i in this.selectedTemperatureSetPoints){
                        selectedNode = document.getElementById(this.selectedTemperatureSetPoints[i] + "-temperatureSetPoints");
                        if(selectedNode){
                            selectedNode.style.borderColor = "black";
                        }
                    }
                    this.selectedTemperatureSetPoints = [];
                },
                updateView: function(){
                    // highlight selectedTemperatureSetPoints when selected.
                    var selectedNode;
                    for(var i in this.selectedTemperatureSetPoints){
                        selectedNode = document.getElementById(this.selectedTemperatureSetPoints[i] + "-temperatureSetPoints");
                        if(selectedNode){
                            selectedNode.style.borderColor = "red";
                        }
                    }
                },
                displayDrag: function(index){
                    console.log('displayDrag', index);
                    var day = Math.floor(index / (60*24));
                    var time = index % (60*24);

                    var dayL, dayH, timeL, timeH;
                    if(day <= this.dragStartDay){
                        dayL = day;
                        dayH = this.dragStartDay;
                    } else {
                        dayL = this.dragStartDay;
                        dayH = day;
                    }
                    if(time <= this.dragStartTime){
                        timeL = time;
                        timeH = this.dragStartTime;
                    } else {
                        timeL = this.dragStartTime;
                        timeH = time;
                    }

                    for(var dayItt = dayL; dayItt <= dayH; ++dayItt){
                        for(var timeItt = timeL; timeItt <= timeH; timeItt += 15){
                            this.selectedTemperatureSetPoints.push(dayItt * 60 * 24 + timeItt);
                        }
                    }

                    this.calculateAverageTemp();
                    this.updateView();
                },
                updateData: function() {
                    // Get data from server.
                    if(this.serverLastQueriedAt === undefined || Date.now() - this.serverLastQueriedAt > 600000){
                        this.serverLastQueriedAt = Date.now();
                        dataStore.sendQueryNow("house", "/tempSettings?", function sendQueryNowCallback(data, code){this.draw();}.bind(this));
                    }
                },
                draw: function() {
                        console.log("draw");

                        var child;
                        var temperatureSetPoints = null;
                        var temperatureSetPointsControls = null;
                        for(child in this.children){
                            if(this.children[child].id ==="temperatureSetPoints"){
                                temperatureSetPoints = this.children[child];
                            }
                            if(this.children[child].id === "temperatureSetPointsControls"){
                                temperatureSetPointsControls = this.children[child];
                            }
                        }

                        // The week view showing temperature set points.
                        if(temperatureSetPoints === null){
                            temperatureSetPoints = document.createElement('div');
                            temperatureSetPoints.id = "temperatureSetPoints";
                            temperatureSetPoints.style["vertical-align"] = "bottom";
                            this.appendChild(temperatureSetPoints);
                        }

                        // The buttons that we don't want to re-draw.
                        if(temperatureSetPointsControls === null){
                            temperatureSetPointsControls = document.createElement('div');
                            temperatureSetPointsControls.id = "temperatureSetPointsControls";
                            temperatureSetPointsControls.style["vertical-align"] = "bottom";
                            this.appendChild(temperatureSetPointsControls);
                            temperatureSetPointsControls.innerHTML = temperatureSetPointsControlsTemplate({});
                        }

                        console.log(dataStore.allDataContainer);
                        console.log(dataStore.allDataContainer['temp_setting_1_week']);

                        for(var k in dataStore.allDataContainer){
                            console.log(k);
                        }

                        var time;
                        if(dataStore.allDataContainer.temp_setting_1_week !== undefined){
                            var populateForm = {};
                            populateForm.temperatureSetKey = {};
                            populateForm.temperatureSetPoints = {};

                            // Populate key data.
                            dataStore.allDataContainer.temp_setting_1_week.temperatureSetKey = {};
                            for(time=0; time < 60*24; time += 60){
                                populateForm.temperatureSetKey[time] = Math.round(time / 60);
                            }

                            for(time=0; time < 60*24*7; time += 15){
                                populateForm.temperatureSetPoints[time] = [dataStore.allDataContainer.temp_setting_1_week.temp_setting_1_week[0][time] -10,
                                    Math.round(10 * dataStore.allDataContainer.temp_setting_1_week.temp_setting_1_week[0][time]) / 10];
                            }
                            console.log("*****");
                            temperatureSetPoints.innerHTML = temperatureSetPointsTemplate(populateForm);

                            this.calculateAverageTemp();
                            document.getElementById("set-temperatureSetPoints").value = this.averageTemperature;
                        }
                        this.displayDrag();
                },
                calculateAverageTemp: function() {
                    var temperatureTotal = 0;
                    var temperatureCount = 0;
                    var time;
                    for(var i in this.selectedTemperatureSetPoints){
                        time = this.selectedTemperatureSetPoints[i];
                        if(dataStore.allDataContainer.temp_setting_1_week.temp_setting_1_week[0][time] !== undefined){
                            temperatureTotal += parseFloat(dataStore.allDataContainer.temp_setting_1_week.temp_setting_1_week[0][time]);
                            temperatureCount += 1;
                        }
                    }

                    this.averageTemperature = (temperatureTotal / temperatureCount).toFixed(1);

                    document.getElementById("set-temperatureSetPoints").value = this.averageTemperature;
                },
                smooth: function(index){
                    console.log('smooth');
                    this.serverLastQueriedAt = Date.now();  // Make sure new data is not loaded for a while.
                    this.selectedTemperatureSetPointsDirty = true;  // Mark section for complete re-draw.
                    this.selectedTemperatureSetPointsUnsaved = true;  // We have data to save.
                    this.calculateAverageTemp();

                    var time;
                    for(var i in this.selectedTemperatureSetPoints){
                        time = this.selectedTemperatureSetPoints[i];
                        if(dataStore.allDataContainer.temp_setting_1_week.temp_setting_1_week[0][time] !== undefined){
                            dataStore.allDataContainer.temp_setting_1_week.temp_setting_1_week[0][time] = this.averageTemperature.toString();
                        }
                    }
                    this.draw();
                },
                setTemperature: function(){
                    console.log('setTemperature');
                    this.serverLastQueriedAt = Date.now();  // Make sure new data is not loaded for a while.
                    this.selectedTemperatureSetPointsDirty = true;  // Mark section for complete re-draw.
                    this.selectedTemperatureSetPointsUnsaved = true;  // We have data to save.

                    this.averageTemperature = document.getElementById("set-temperatureSetPoints").value;
                    console.log("this.averageTemperature: ", this.averageTemperature);
                    for(var i in this.selectedTemperatureSetPoints){
                        var time = this.selectedTemperatureSetPoints[i];
                        if(dataStore.allDataContainer.temp_setting_1_week.temp_setting_1_week[0][time] !== undefined){
                            dataStore.allDataContainer.temp_setting_1_week.temp_setting_1_week[0][time] = this.averageTemperature.toString();
                        }
                    }
                    this.draw();
                },
                cancel: function(){
                    console.log('cancel');
                    this.serverLastQueriedAt = Date.now() - 1000000;  // Make data reload next time the section is drawn.
                    this.selectedTemperatureSetPointsDirty = true;  // Mark section for complete re-draw.
                    this.selectedTemperatureSetPointsUnsaved = false;  // No data to save anymore.
                    this.updateData();                              // Do a DB lookup.
                },
                save: function(){
                    console.log('save');
                    if(this.selectedTemperatureSetPointsUnsaved !== true){
                        return;
                    }

                    var dataToSend = [{'type': 'cyclicBufferInput',
                        'data': {'key': 'temp_setting_1_week',
                            'label': 'temp_setting_1_week',
                            'val': dataStore.allDataContainer.temp_setting_1_week.temp_setting_1_week[0]
                        }
                    }];

                    console.log(dataToSend);

                    function readTemperatureDatacallback(){
                        dataStore.sendQueryNow("house", "/tempSettings?", function(data){
                                console.log("Force lookup.", data);
                                this.updateView();
                                }.bind(this));
                    }

                    dataStore.serverConnectionsToSend.send("send", JSON.stringify(dataToSend), function(testvar){readTemperatureDatacallback();}, 6);

                    this.selectedTemperatureSetPointsUnsaved = false;  // No data to save anymore.
                }
            }
        });
    })(xtag);
</script>
